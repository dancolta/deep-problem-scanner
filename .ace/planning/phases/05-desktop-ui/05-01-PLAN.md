# Plan: Setup and Upload Screens

**Phase:** 5 - Desktop UI
**Plan:** 1 of 2 in phase
**Status:** Ready

## Objective

Wire all backend services into the Electron main process via IPC handlers, build the fully functional Setup page with Google OAuth connection and settings, and build the Upload page with CSV parsing, preview, validation, and row range selection.

## Tasks

### Task 1: IPC Handler Registration & Service Registry
**Zone:** ALPHA
**Files:**
- `electron/service-registry.ts`
- `electron/ipc-handlers.ts`
- `electron/main.ts` (modify — add handler registration)

**Action:**
1. Create `electron/service-registry.ts`:
   - `ServiceRegistry` class (singleton pattern)
   - Lazy-initializes all services on first access:
     - `scannerService: ScannerService`
     - `annotationService: AnnotationService`
     - `googleAuth: GoogleAuthService`
     - `sheetsService: SheetsService` (needs authenticated OAuth2Client)
     - `driveService: DriveService` (needs authenticated OAuth2Client)
     - `emailGenerator: EmailGenerator`
     - `leadPipeline: LeadPipeline`
   - `getAuthenticatedSheets(): Promise<SheetsService>` — Gets auth client, creates SheetsService
   - `getAuthenticatedDrive(): Promise<DriveService>` — Gets auth client, creates DriveService
   - Services that need auth are created on-demand after authentication

2. Create `electron/ipc-handlers.ts`:
   - `registerAllHandlers(ipcMain: IpcMain): void`
   - Register handlers for ALL IPC channels defined in `src/shared/ipc-channels.ts`:

   **Google Auth handlers:**
   - `GOOGLE_AUTH_START`: Call `googleAuth.authenticate()`, return tokens
   - `GOOGLE_AUTH_STATUS`: Call `googleAuth.getAuthStatus()`, return status
   - `GOOGLE_AUTH_REVOKE`: Call `googleAuth.revoke()`

   **CSV handlers:**
   - `CSV_PARSE`: Receive file path, read file content via `fs.readFile`, run through `leadPipeline.processUpload()`, return PipelineResult
   - `CSV_VALIDATE`: Receive CSV content string, validate headers only, return ValidationResult

   **Scan handlers:**
   - `SCAN_START`: Receive { leads: Lead[], spreadsheetId: string }, run full pipeline:
     1. Initialize scanner
     2. For each lead: scan → annotate → compress → upload to Drive → generate email
     3. Append results to Sheet
     4. Send progress updates via `webContents.send(SCAN_PROGRESS, progress)`
     5. Return complete results
   - `SCAN_CANCEL`: Set cancel flag, scanner stops processing new URLs

   **Settings handlers:**
   - `SETTINGS_GET`: Read settings from electron-store or JSON file
   - `SETTINGS_SET`: Write settings

   **Sheets handlers:**
   - `SHEETS_APPEND`: Append rows to sheet
   - `SHEETS_READ`: Read rows from sheet
   - `SHEETS_CHECK_DUPLICATES`: Check duplicate URLs

   **Drive handlers:**
   - `DRIVE_UPLOAD`: Upload screenshot buffer to Drive

   **Gmail handlers (placeholder for Phase 6):**
   - `GMAIL_CREATE_DRAFT`: Placeholder returning not-implemented
   - `GMAIL_SEND`: Placeholder returning not-implemented

   **Scheduler handlers (placeholder for Phase 6):**
   - `SCHEDULER_START`, `SCHEDULER_STOP`, `SCHEDULER_STATUS`: Placeholders

3. Modify `electron/main.ts`:
   - Import and call `registerAllHandlers(ipcMain)` after app is ready
   - Import `dotenv` config at top (already there)

**Verify:**
- [ ] ServiceRegistry initializes all services correctly
- [ ] All IPC channels from ipc-channels.ts have registered handlers
- [ ] Auth-dependent services are created after authentication
- [ ] SCAN_START handler chains the full pipeline (scan → annotate → upload → email → sheet)
- [ ] Progress updates sent to renderer during scanning
- [ ] TypeScript compiles without errors

**Done when:**
All IPC handlers are registered in main process, ServiceRegistry provides lazy-initialized services, and the full scan pipeline is wired through SCAN_START handler.

---

### Task 2: Setup Page (OAuth Connection + Settings)
**Zone:** BETA
**Files:**
- `src/renderer/pages/SetupPage.tsx`
- `src/renderer/pages/SetupPage.css`

**Action:**
1. Rewrite `src/renderer/pages/SetupPage.tsx` as a full functional page:

   **Layout sections:**

   a) **Google Account Connection** (top section):
   - Status indicator: green dot + "Connected" or red dot + "Not Connected"
   - "Connect Google Account" button → calls `window.electronAPI.invoke(IPC_CHANNELS.GOOGLE_AUTH_START)`
   - On success: show connected state with email/account info
   - "Disconnect" button → calls `GOOGLE_AUTH_REVOKE`
   - Loading spinner while OAuth flow is in progress
   - Error message display if auth fails

   b) **Gemini API Key** (middle section):
   - Input field (password type with show/hide toggle)
   - "Test Connection" button → test the key with a simple API call
   - Status: valid/invalid/untested indicator
   - Save button stores to settings

   c) **Google Sheet URL** (middle section):
   - Input field for the Google Sheet URL
   - Parse spreadsheet ID from URL (extract from `https://docs.google.com/spreadsheets/d/{ID}/...`)
   - "Test Connection" button → try to read the sheet
   - Status indicator

   d) **Scan Settings** (bottom section):
   - Concurrency slider/select: 1-5 (default 2)
   - Send interval input: minutes between emails (default 15)
   - Timezone select dropdown

   e) **Save Settings** button at bottom

   **State management:**
   - Use React useState for all form fields
   - Load saved settings on mount via `SETTINGS_GET`
   - Save all settings via `SETTINGS_SET`
   - Use the `useIpcInvoke` hook from `src/renderer/hooks/useIpc.ts`

2. Create `src/renderer/pages/SetupPage.css`:
   - Form sections with cards (dark cards on darker background)
   - Status indicators (colored dots)
   - Input styling (dark inputs, light text, border on focus)
   - Button styles (primary action = accent color, secondary = outline)
   - Consistent spacing and typography

**Verify:**
- [ ] OAuth connect button triggers auth flow via IPC
- [ ] Auth status displays correctly (connected/disconnected)
- [ ] API key input with show/hide and test button
- [ ] Sheet URL parsing extracts spreadsheet ID
- [ ] Settings persist via save/load
- [ ] Clean, dark-themed UI matching the app's design
- [ ] TypeScript compiles without errors

**Done when:**
Setup page allows user to connect Google account, enter Gemini API key, configure Sheet URL, adjust scan settings, and save everything — all fully functional via IPC.

---

### Task 3: Upload Page (CSV + Lead Pipeline)
**Zone:** GAMMA
**Files:**
- `src/renderer/pages/UploadPage.tsx`
- `src/renderer/pages/UploadPage.css`

**Action:**
1. Rewrite `src/renderer/pages/UploadPage.tsx` as a full functional page:

   **Layout sections:**

   a) **CSV Upload Zone** (top):
   - Drag-and-drop zone with dashed border
   - "Browse Files" button inside the zone
   - Accept only .csv files
   - Use HTML5 File API: `input type="file" accept=".csv"`
   - On file select: read file content with FileReader, send via `CSV_PARSE` IPC
   - Show filename and file size after selection

   b) **Validation Results** (shown after parse):
   - Green banner if valid: "Found {N} leads, {M} ready to scan"
   - Red banner with details if invalid: "Missing columns: company_name, contact_email"
   - Warning banner for partial issues: "{X} leads have invalid data"

   c) **Leads Preview Table** (shown after successful parse):
   - Scrollable table showing first 20 leads
   - Columns: #, Company, Website, Contact, Email, Status
   - Status column: green check for valid, red X for invalid, yellow for duplicate
   - Row count display: "Showing 20 of {total} leads"

   d) **Row Range Selection** (below table):
   - "Scan all" checkbox (default checked)
   - If unchecked: Start row and End row number inputs
   - Live count: "Will scan {N} leads"
   - Validation: end >= start, values within range

   e) **Summary Panel** (right side or below):
   - Total leads parsed: {N}
   - Valid leads: {N}
   - Invalid leads: {N} (with expandable details)
   - Duplicate emails removed: {N}
   - Already scanned (in Sheet): {N}
   - Ready to scan: {N}

   f) **Action Buttons** (bottom):
   - "Start Scan" button (primary, accent color) — disabled if no valid leads
   - Clicking "Start Scan" navigates to /scan page and triggers SCAN_START via IPC
   - "Clear" button to reset the upload

   **State management:**
   - useState for: file, parseResult, rowRange, isLoading
   - useNavigate from react-router-dom for navigating to /scan after starting
   - File reading via FileReader API in the renderer

2. Create `src/renderer/pages/UploadPage.css`:
   - Drag-and-drop zone styling (dashed border, hover highlight)
   - Table styling (dark rows, alternating stripes, fixed header)
   - Validation banners (green/yellow/red backgrounds)
   - Summary panel styling
   - Consistent with app theme

**Verify:**
- [ ] Drag-and-drop and file browse both work
- [ ] CSV is parsed and results displayed in table
- [ ] Validation errors shown clearly
- [ ] Row range selection updates lead count
- [ ] Summary panel shows all pipeline stats
- [ ] Start Scan button triggers scan and navigates
- [ ] Clean UI matching dark theme
- [ ] TypeScript compiles without errors

**Done when:**
Upload page allows CSV upload via drag-and-drop or browse, shows parsed leads in a preview table, displays validation results, lets user select row range, and starts the scan pipeline.

---

## Checkpoints

None - fully autonomous execution.

## Success Criteria

- [ ] All tasks completed
- [ ] IPC handlers wire all backend services to renderer
- [ ] Setup page connects Google, saves settings
- [ ] Upload page parses CSV, shows preview, starts scan
- [ ] TypeScript compiles without errors
- [ ] Webpack builds successfully
