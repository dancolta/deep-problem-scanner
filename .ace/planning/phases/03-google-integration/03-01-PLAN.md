# Plan: Google OAuth & API Integration

**Phase:** 3 - Google Integration (OAuth, Sheets, Drive)
**Plan:** 1 of 1 in phase
**Status:** Ready

## Objective

Implement Google OAuth2 desktop flow with secure token storage, Google Sheets API for reading/writing scan results with duplicate detection, and Google Drive API for uploading annotated screenshots with shareable URLs.

## Tasks

### Task 1: Google OAuth Desktop Flow & Token Management
**Zone:** ALPHA
**Files:**
- `src/services/google/auth.ts`
- `src/services/google/token-store.ts`
- `src/services/google/types.ts`

**Action:**
1. Create `src/services/google/types.ts`:
   - `GoogleAuthTokens`: { access_token, refresh_token, expiry_date, token_type, scope }
   - `AuthStatus`: 'authenticated' | 'expired' | 'not_authenticated' | 'revoked'
   - `GoogleServiceConfig`: { clientId, clientSecret, scopes }
   - Required scopes: `https://www.googleapis.com/auth/spreadsheets`, `https://www.googleapis.com/auth/drive.file`, `https://www.googleapis.com/auth/gmail.compose`

2. Create `src/services/google/token-store.ts`:
   - `TokenStore` class for secure token persistence
   - `saveTokens(tokens: GoogleAuthTokens): Promise<void>` — In Electron: use `safeStorage.encryptString()` + write to app data path. In dev/non-Electron: write JSON to `~/.deep-problem-scanner/tokens.json`
   - `loadTokens(): Promise<GoogleAuthTokens | null>` — Read and decrypt
   - `clearTokens(): Promise<void>` — Delete stored tokens
   - `getStoragePath(): string` — Use Electron's `app.getPath('userData')` or fallback to home dir
   - Detect Electron environment: check if `process.type === 'browser'` and safeStorage is available
   - Handle corrupt/unreadable token files gracefully (delete and return null)

3. Create `src/services/google/auth.ts`:
   - `GoogleAuthService` class
   - Constructor takes clientId, clientSecret from env
   - Uses `google.auth.OAuth2` from googleapis
   - `authenticate(): Promise<GoogleAuthTokens>`:
     1. Check TokenStore for existing valid tokens
     2. If tokens exist and not expired, return them
     3. If tokens exist but expired, try refresh via `oauth2Client.refreshAccessToken()`
     4. If no tokens or refresh fails, start new OAuth flow:
        a. Generate auth URL with scopes
        b. Open URL in system default browser using Electron's `shell.openExternal()`
        c. Start local HTTP server on random port (use Node `http.createServer`) to receive OAuth redirect callback
        d. Exchange authorization code for tokens
        e. Save tokens via TokenStore
     5. Return tokens
   - `getAuthenticatedClient(): Promise<OAuth2Client>` — Returns configured OAuth2Client with valid tokens (auto-refreshes)
   - `getAuthStatus(): Promise<AuthStatus>` — Check current auth state
   - `revoke(): Promise<void>` — Revoke tokens via Google API + clear TokenStore
   - `onTokenRefresh(callback)` — Register callback for when tokens are auto-refreshed
   - Redirect URI: `http://localhost:{port}/oauth/callback` (dynamic port)

**Verify:**
- [ ] Types are well-defined with all required scopes
- [ ] TokenStore encrypts in Electron, falls back to plain JSON in dev
- [ ] OAuth flow opens browser, receives callback, exchanges code
- [ ] Token refresh works for expired tokens
- [ ] Revocation clears stored tokens
- [ ] TypeScript compiles without errors

**Done when:**
`GoogleAuthService.authenticate()` completes the full OAuth desktop flow, stores tokens securely, auto-refreshes expired tokens, and provides an authenticated OAuth2Client for other Google services.

---

### Task 2: Google Sheets API Service
**Zone:** BETA
**Files:**
- `src/services/google/sheets.ts`

**Action:**
1. Create `src/services/google/sheets.ts`:
   - `SheetsService` class
   - Constructor takes `OAuth2Client` (from auth service)
   - Uses `google.sheets('v4')` from googleapis

   **Core methods:**

   a) `appendScanResults(spreadsheetId: string, rows: SheetRow[]): Promise<void>`
   - Append rows to the sheet using `sheets.spreadsheets.values.append`
   - Map SheetRow fields to column order: company_name, website_url, contact_name, contact_email, scan_status, screenshot_url, diagnostics_summary, email_subject, email_body, email_status, scheduled_time, sent_time
   - Range: 'Sheet1!A:L' (auto-detect next empty row)
   - valueInputOption: 'USER_ENTERED'

   b) `readRows(spreadsheetId: string, range?: string): Promise<SheetRow[]>`
   - Read all data rows (skip header)
   - Parse into SheetRow objects
   - Default range: 'Sheet1!A2:L' (skip header row)

   c) `checkDuplicates(spreadsheetId: string, websiteUrls: string[]): Promise<string[]>`
   - Read website_url column (B)
   - Return URLs that already exist in the sheet
   - Used to skip already-scanned sites

   d) `updateRowStatus(spreadsheetId: string, rowIndex: number, updates: Partial<SheetRow>): Promise<void>`
   - Update specific cells in a row (e.g., email_status from 'draft' to 'scheduled')
   - Use `sheets.spreadsheets.values.update`
   - rowIndex is 0-based data row (add 2 for sheet row: +1 for header, +1 for 1-based index)

   e) `getApprovedRows(spreadsheetId: string): Promise<{ row: SheetRow; rowIndex: number }[]>`
   - Read all rows, filter where email_status === 'draft' and a hypothetical 'approved' column is checked
   - Return rows with their index for later updates

   f) `getScheduledRows(spreadsheetId: string): Promise<{ row: SheetRow; rowIndex: number }[]>`
   - Filter rows where email_status === 'scheduled'
   - Used for scheduler recovery on app startup

   g) `ensureHeaders(spreadsheetId: string): Promise<void>`
   - Check if first row has headers
   - If empty sheet, write header row: ['Company', 'Website URL', 'Contact Name', 'Contact Email', 'Scan Status', 'Screenshot URL', 'Diagnostics', 'Email Subject', 'Email Body', 'Email Status', 'Scheduled Time', 'Sent Time']

   **Helper:**
   - `COLUMN_MAP` constant mapping SheetRow field names to column letters
   - `rowToArray(row: SheetRow): string[]` — Convert SheetRow to ordered array of values
   - `arrayToRow(arr: string[]): SheetRow` — Parse array back to SheetRow

**Verify:**
- [ ] appendScanResults maps SheetRow fields to correct column order
- [ ] readRows parses sheet data back into typed SheetRow objects
- [ ] checkDuplicates correctly identifies existing URLs
- [ ] updateRowStatus targets correct cell range
- [ ] ensureHeaders creates header row on empty sheets
- [ ] TypeScript compiles without errors

**Done when:**
SheetsService can append scan results, read rows, detect duplicates, update individual row statuses, filter by email status, and ensure header row exists.

---

### Task 3: Google Drive API Service
**Zone:** GAMMA
**Files:**
- `src/services/google/drive.ts`

**Action:**
1. Create `src/services/google/drive.ts`:
   - `DriveService` class
   - Constructor takes `OAuth2Client`
   - Uses `google.drive('v3')` from googleapis

   **Core methods:**

   a) `ensureAppFolder(): Promise<string>`
   - Search for folder named "Deep Problem Scanner" in Drive root
   - Query: `mimeType='application/vnd.google-apps.folder' and name='Deep Problem Scanner' and trashed=false`
   - If exists, return folder ID
   - If not, create it and return folder ID
   - Cache folder ID in memory after first lookup

   b) `uploadScreenshot(buffer: Buffer, filename: string): Promise<{ fileId: string; webViewLink: string; directLink: string }>`
   - Ensure app folder exists
   - Upload file to the app folder:
     ```
     drive.files.create({
       requestBody: {
         name: filename,
         mimeType: 'image/png',
         parents: [folderId],
       },
       media: {
         mimeType: 'image/png',
         body: Readable.from(buffer),
       },
       fields: 'id, webViewLink',
     })
     ```
   - Set permission: anyone with link can view
     ```
     drive.permissions.create({
       fileId,
       requestBody: {
         role: 'reader',
         type: 'anyone',
       },
     })
     ```
   - Return:
     - fileId: the Drive file ID
     - webViewLink: the Google Drive viewer URL
     - directLink: `https://drive.google.com/uc?export=view&id=${fileId}` (for img src embedding in Gmail)

   c) `deleteFile(fileId: string): Promise<void>`
   - Delete a file from Drive (for cleanup/re-uploads)

   d) `getFileLink(fileId: string): string`
   - Return direct image link: `https://drive.google.com/uc?export=view&id=${fileId}`

   e) `listScreenshots(): Promise<{ id: string; name: string; createdTime: string }[]>`
   - List all files in app folder
   - Useful for management/cleanup UI later

   **Error handling:**
   - Wrap all API calls in try/catch
   - Handle quota errors (403) with clear error message
   - Handle auth errors (401) — suggest re-authentication
   - Handle not found (404) — folder was deleted, recreate

**Verify:**
- [ ] App folder is created once and reused
- [ ] Screenshots upload as PNG with correct filename
- [ ] Permissions are set to anyone-with-link-can-view
- [ ] Direct link format works for img src embedding
- [ ] Error handling covers auth, quota, and not-found cases
- [ ] TypeScript compiles without errors

**Done when:**
DriveService can create/reuse an app folder, upload annotated screenshots, set public view permissions, and return embeddable direct links for Gmail HTML.

---

## Checkpoints

None - fully autonomous execution.

## Success Criteria

- [ ] All tasks completed
- [ ] All verifications pass
- [ ] OAuth flow opens browser and completes token exchange
- [ ] Tokens stored securely and auto-refresh works
- [ ] Sheets API reads/writes/updates rows correctly
- [ ] Drive uploads return working direct image URLs
- [ ] TypeScript compiles without errors
